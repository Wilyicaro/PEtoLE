/********************************************************************
	Minecraft: Pocket Edition - Decompilation Project
	Copyright (C) 2023 iProgramInCpp
	
	The following code is licensed under the BSD 1 clause license.
	SPDX-License-Identifier: BSD-1-Clause
 ********************************************************************/

#include "../Packet.hpp"
#include "world/level/levelgen/chunk/LevelChunk.hpp"

ChunkDataPacket::ChunkDataPacket(Level* level, const TilePos& minPos, int xs, int ys, int zs) : m_pos(minPos), m_xs(xs), m_ys(ys), m_zs(zs)
{
	uint8_t* rawData = level->getBlocksAndData(minPos, xs, ys, zs);
	size_t compressedSize = 0;
	uint8_t* compressed = ZlibDeflateToMemoryLvl(rawData, xs * ys * zs * 5 / 2, &compressedSize, 1);
	m_size = compressedSize;
	m_data.WriteAlignedBytes(compressed, m_size);
	delete[] compressed;
}

void ChunkDataPacket::handle(const RakNet::RakNetGUID& guid, NetEventCallback* pCallback)
{
	pCallback->handle(guid, this);
}

void ChunkDataPacket::write(RakNet::BitStream* bs)
{
	bs->Write((unsigned char)PACKET_CHUNK_DATA);
	bs->Write(m_pos.x);
	bs->Write(m_pos.y);
	bs->Write(m_pos.z);
	bs->Write(m_xs);
	bs->Write(m_ys);
	bs->Write(m_zs);
	bs->Write(m_size);
	bs->WriteAlignedBytes(m_data.GetData(), m_size);
}

void ChunkDataPacket::read(RakNet::BitStream* bs)
{
	bs->Read(m_pos.x);
	bs->Read(m_pos.y);
	bs->Read(m_pos.z);
	bs->Read(m_xs);
	bs->Read(m_ys);
	bs->Read(m_zs);
	bs->Read(m_size);

	uint8_t* compressed = new uint8_t[m_size];
	bs->ReadAlignedBytes(compressed, m_size);

	uint8_t* decompressed = ZlibInflateToMemory(compressed, m_size, m_xs * m_ys * m_zs * 5 / 2);
	m_data.Reset();
	m_data.WriteAlignedBytes(decompressed, m_xs * m_ys * m_zs * 5 / 2);
	m_data.ResetReadPointer();

	delete[] compressed;
	delete[] decompressed;
}
